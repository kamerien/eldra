# ワールド間連携システム設計

## 1. データ構造

### 1.1 共有データ

```yaml
DeckData:
    format: string # "Standard", "Legacy", "Vintage"
    mainDeck: Card[]
    sideboard: Card[]
    timestamp: long
    hash: string

PlayerProfile:
    id: string
    name: string
    preferences: PreferenceData
    statistics: StatisticsData
    lastLogin: long

GameState:
    matchId: string
    players: PlayerData[]
    turnCount: int
    phase: string
    timestamp: long
```

### 1.2 永続化データ

```yaml
LocalStorage:
    - デッキリスト
    - プレイヤー設定
    - 統計データ
    - キャッシュ

RemoteStorage:
    - プレイヤープロファイル
    - マッチ履歴
    - ランキングデータ
```

## 2. 同期システム

### 2.1 データ転送

```yaml
シリアライズ形式:
    デッキデータ:
        - JSONフォーマット
        - Base64エンコード
        - 圧縮形式: GZIP

転送方法:
    - VRChatトリガー
    - プレイヤー変数
    - ネットワークイベント
```

### 2.2 状態管理

```yaml
ステート同期:
    デッキ状態:
        - カードリスト
        - カード配置
        - 表示/裏向き

    プレイヤー状態:
        - ライフポイント
        - 手札枚数
        - フェーズ情報

    ゲーム状態:
        - ターン情報
        - スタック
        - 優先権
```

## 3. ワールド間移動

### 3.1 移動プロトコル

```yaml
1. 移動準備:
    - 現在の状態を保存
    - データをシリアライズ
    - 一時保存領域に格納

2. ワールド移動:
    - 目的地ワールドのID取得
    - プレイヤーをテレポート
    - インスタンス情報を保持

3. 状態復元:
    - データの読み込み
    - 状態の復元
    - UI/表示の更新
```

### 3.2 エラー処理

```yaml
リカバリー手順:
    通信エラー: 1. 接続再試行
        2. ローカルキャッシュ使用
        3. フォールバック処理

    データ破損: 1. チェックサム検証
        2. バックアップ復元
        3. 初期状態に戻す

    同期エラー: 1. 状態の再同期
        2. 差分の適用
        3. マスターに同期
```

## 4. メモリ管理

### 4.1 リソース制御

```yaml
メモリプール:
    アクティブデータ:
        - 現在のデッキ
        - 表示中のカード
        - UI要素

    非アクティブデータ:
        - 履歴データ
        - 未使用カード
        - キャッシュ
```

### 4.2 解放戦略

```yaml
解放条件:
    - メモリ使用量 > 閾値
    - 未使用時間 > 5分
    - システム要求時

優先順位: 1. 未使用キャッシュ
    2. 履歴データ
    3. 非表示カード
```

## 5. セキュリティ

### 5.1 データ検証

```yaml
チェック項目:
    - デッキの正当性
    - カード枚数制限
    - フォーマット制限
    - バージョン整合性

対策:
    - チェックサム検証
    - タイムスタンプ確認
    - シグネチャ検証
```

### 5.2 不正防止

```yaml
監視項目:
    - 不正なカード追加
    - 状態の改ざん
    - タイミング操作

対応:
    - ログの記録
    - 自動報告
    - アクセス制限
```

## 6. パフォーマンス最適化

### 6.1 通信最適化

```yaml
データ圧縮:
    - 差分転送
    - バッチ処理
    - プリフェッチ

帯域制御:
    - 優先度設定
    - キューイング
    - レート制限
```

### 6.2 処理最適化

```yaml
非同期処理:
    - データロード
    - 状態同期
    - UI更新

キャッシュ戦略:
    - プリロード
    - 予測キャッシュ
    - LRU管理
```

## 7. 運用管理

### 7.1 モニタリング

```yaml
監視項目:
    - ワールド間移動成功率
    - データ同期エラー率
    - メモリ使用量
    - 応答時間

アラート:
    - エラー率 > 5%
    - 移動失敗 > 10件
    - 同期遅延 > 3秒
```

### 7.2 メンテナンス

```yaml
定期作業:
    - キャッシュクリア
    - データ最適化
    - エラーログ分析
    - パフォーマンス調整

緊急対応:
    - システム復旧手順
    - データバックアップ
    - 切り戻し手順
```
